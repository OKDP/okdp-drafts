
# JupyterHub with authentication ensured by DEX

This is a meta-chart embedding the original JupyterHub Helm chart with a simple, proprietary DEX Helm chart.

This chart optionally integrate some configuration to be compatible with a cluster protected with [Kyverno](https://kyverno.io/).

Here is a sample of a specific values.yaml file:

```
kyverno:
  namespace: # Set to the kyverno namespace if kyverno is installed. Leave blank if not 
jupyterhub:
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: cluster-issuer1
    hosts:
      - jupyter.space1.ingress.mycluster.mydomain.internal
    tls:
      - hosts:
          - jupyter.space1.ingress.mycluster.mydomain.internal
        secretName: jupyterhub-tls
  singleuser:
    storage:
      dynamic:
        storageClass: longhorn
      capacity: 1Gi
    image:
      name: quay.io/jupyterhub/k8s-singleuser-sample
      tag: 3.2.1
      pullPolicy: IfNotPresent
  hub:
    config:
      GenericOAuthenticator:
        oauth_callback_url: https://jupyter.space1.ingress.mycluster.mydomain.internal/hub/oauth_callback
        authorize_url: https://dex.jupyter.space1.ingress.mycluster.mydomain.internal/dex/auth
        token_url: https://dex.jupyter.space1.ingress.mycluster.mydomain.internal/dex/token
        userdata_url: https://dex.jupyter.space1.ingress.mycluster.mydomain.internal/dex/userinfo
        admin_groups:
          - space1-admin
        allowed_groups:
          - space1-jupyter
dex:
  ingress:
    host: dex.jupyter.space1.ingress.mycluster.mydomain.internal
    clusterIssuer: cluster-issuer1
  connectors:
    # Place here your DEX connector configuration
    - id: ....
      config:
         ...
  firstStaticClient:
    redirectURIs:
      - https://jupyter.space1.ingress.mycluster.mydomain.internal/hub/oauth_callback
```

Obviously most of the variables should be adjusted to your environment.

Note than the binding between these two components is performed transparently. This binding involve two aspects:

- A clientId/secretId credential shared by both party.
- The DEX server is secured by SSL and the associated CA must be recognized by JupyterHub.

For the first point, the DEX helm chart generate a secret with a random value. And the values of this secret are 
injected in JupyterHub through environment variables.

> This secret us generated by using https://github.com/mittwald/kubernetes-secret-generator. But another tool can be
used instead.

For the second aspect, the DEX server certificate is generated by CertificateManager. It generate a secret containing 
the DEX server TLS Key Pair and the associated Certificate Authority. 

This secret is mounted inside the JupyterHub Pod, and the resulting path is provided in the JupyterHub configuration.

Please note this is easy to setup as both side are in the same namespace. Otherwise, a mechanism to replicate the 
secrets across namespace will need to be implemented.

